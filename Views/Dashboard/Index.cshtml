@model PruebaDeveloper2026.Application.ViewModels.DashboardVm

@{
    ViewData["Title"] = "ENSU Dashboard - Nuevo León";
    var periods = Model?.Periods ?? new List<string>();
    var selected = string.IsNullOrWhiteSpace(Model?.SelectedPeriod) ? "all" : Model.SelectedPeriod;
}

<style>
    .dash-wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px 16px 40px;
    }

    .dash-header {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 14px;
        flex-wrap: wrap;
    }

    .dash-title h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 800;
        letter-spacing: -.02em;
    }

    .dash-title p {
        margin: 6px 0 0;
        color: #666;
    }

    .controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        .controls select, .controls input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
        }

    .btn {
        padding: 9px 14px;
        border-radius: 10px;
        border: 1px solid #ddd;
        background: #111;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
    }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

    .btn-secondary {
        background: #fff;
        color: #111;
    }

    .status {
        margin-top: 10px;
        display: none;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #eee;
    }

        .status.loading {
            display: block;
            background: #fafafa;
            color: #333;
        }

        .status.error {
            display: block;
            background: #fff5f5;
            border-color: #ffd3d3;
            color: #b00020;
        }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0,1fr));
        gap: 12px;
        margin-top: 18px;
    }

    .card {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 6px 18px rgba(0,0,0,.03);
    }

    .kpi-title {
        color: #666;
        font-weight: 700;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: .06em;
    }

    .kpi-value {
        font-size: 26px;
        font-weight: 900;
        margin-top: 6px;
    }

    .kpi-sub {
        color: #777;
        margin-top: 2px;
        font-size: 13px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
        margin-top: 12px;
    }

    .grid-2b {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
    }

    .card h3 {
        margin: 0 0 10px;
        font-size: 16px;
        font-weight: 900;
    }

    .card .hint {
        margin-top: 10px;
        color: #777;
        font-size: 12px;
    }

    .chart-box {
        height: 340px;
    }

        .chart-box.sm {
            height: 280px;
        }

        .chart-box.lg {
            height: 380px;
        }

    .legend-mini {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 8px;
        color: #666;
        font-size: 12px;
    }

    .pill {
        background: #f6f6f6;
        border: 1px solid #eee;
        padding: 6px 10px;
        border-radius: 999px;
    }

    .muted {
        color: #666;
    }

    @@media (max-width: 992px) {
        .kpi-grid {
            grid-template-columns: repeat(2, minmax(0,1fr));
        }

        .grid-2 {
            grid-template-columns: 1fr;
        }

        .grid-2b {
            grid-template-columns: 1fr;
        }

        .chart-box.lg {
            height: 340px;
        }
    }
</style>

<div class="dash-wrap">
    <div class="dash-header">
        <div class="dash-title">
            <h1>ENSU – Percepción de inseguridad (Nuevo León)</h1>
            <p>Marzo, Junio, Septiembre y Diciembre 2024 • Filtros + comparación temporal</p>
        </div>

        <div class="controls">
            <label for="estadoInput">Estado</label>
            <input id="estadoInput" value="@Model.Estado" />

            <label for="periodSelect">Periodo</label>
            <select id="periodSelect">
                <option value="all" selected="@(selected == "all")">Serie temporal (todos)</option>
                @foreach (var p in periods)
                {
                    <option value="@p" selected="@(selected == p)">@p</option>
                }
            </select>

            <button id="btnLoad" class="btn" type="button">Consultar</button>
            <button id="btnReset" class="btn btn-secondary" type="button">Reset</button>
        </div>
    </div>

    <div id="statusBox" class="status loading">Cargando datos…</div>

    <!-- KPIs -->
    <div class="kpi-grid">
        <div class="card">
            <div class="kpi-title">% Inseguridad (periodo seleccionado)</div>
            <div class="kpi-value" id="kpiPct">—</div>
            <div class="kpi-sub" id="kpiPctSub">—</div>
        </div>
        <div class="card">
            <div class="kpi-title">Municipio más inseguro</div>
            <div class="kpi-value" id="kpiTopMuni">—</div>
            <div class="kpi-sub" id="kpiTopMuniSub">—</div>
        </div>
        <div class="card">
            <div class="kpi-title">Municipio más seguro</div>
            <div class="kpi-value" id="kpiBottomMuni">—</div>
            <div class="kpi-sub" id="kpiBottomMuniSub">—</div>
        </div>
        <div class="card">
            <div class="kpi-title">Brecha de género</div>
            <div class="kpi-value" id="kpiGeneroGap">—</div>
            <div class="kpi-sub muted">Diferencia % (Mujeres – Hombres)</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid-2">
        <div class="card">
            <h3>1) Comparación en el tiempo</h3>
            <div class="chart-box lg">
                <canvas id="chartTime"></canvas>
            </div>
            <div class="legend-mini">
                <span class="pill">Línea: % Inseguro</span>
                <span class="pill">Escala: 0–100</span>
            </div>
        </div>

        <div class="card">
            <h3>4) Perspectiva de género</h3>
            <div class="chart-box sm">
                <canvas id="chartGenero"></canvas>
            </div>
            <div class="hint">Comparación del porcentaje de inseguridad por género (periodo base).</div>
        </div>
    </div>

    <div class="grid-2b">
        <div class="card">
            <h3>2) Municipios más inseguros (Top 5)</h3>
            <div class="chart-box">
                <canvas id="chartTop"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>2) Municipios más seguros (Bottom 5)</h3>
            <div class="chart-box">
                <canvas id="chartBottom"></canvas>
            </div>
        </div>
    </div>

    <div class="grid-2">
        <div class="card">
            <h3>3) Inseguridad por tipo de lugar</h3>
            <div class="chart-box lg">
                <canvas id="chartLugar"></canvas>
            </div>
            <div class="hint">
                Si actualmente aparecen códigos (ej. <b>BP1_2_01</b>…), luego los mapeamos a nombres reales (cajero, transporte, calle, etc.).
            </div>
        </div>

        <div class="card">
            <h3>Datos / Notas</h3>
            <div class="muted" style="line-height:1.5;">
                <p style="margin-top:0;">
                    • Fuente: ENSU (INEGI) – conjunto_de_datos_ensu_cb.
                </p>
                <p>
                    • Este dashboard funciona sin BD: lee CSV de AppData y calcula indicadores al vuelo.
                </p>
                <hr />
                <div class="muted">
                    <div><b>Periodo base:</b> <span id="basePeriodLabel">—</span></div>
                    <div><b>Estado:</b> <span id="estadoLabel">—</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let chartTime, chartTop, chartBottom, chartLugar, chartGenero;

    const statusBox = document.getElementById('statusBox');
    const btnLoad = document.getElementById('btnLoad');
    const btnReset = document.getElementById('btnReset');

    function setStatus(type, text) {
        statusBox.className = 'status ' + type;
        statusBox.textContent = text;
    }

    function clearStatus() {
        statusBox.className = 'status';
        statusBox.textContent = '';
    }

    function pct(v) {
        if (v === null || v === undefined) return '—';
        const n = Number(v);
        if (Number.isNaN(n)) return '—';
        return n.toFixed(2) + '%';
    }

    function destroyIf(chart) { if (chart) chart.destroy(); }

    async function fetchData() {
        const estado = document.getElementById('estadoInput').value || "NUEVO LEÓN";
        const period = document.getElementById('periodSelect').value || "all";

        // usa la ruta real de tu controller: /dashboard/data
        const url = `/dashboard/data?estado=${encodeURIComponent(estado)}&period=${encodeURIComponent(period)}`;

        const res = await fetch(url);
        if (!res.ok) {
            const t = await res.text();
            throw new Error(t || 'Error al consultar.');
        }
        return await res.json();
    }

    function updateKpis(data) {
        // Usa lo que venga del backend (más confiable)
        const basePeriod = data.basePeriod ?? '—';
        const estado = data.estado ?? (document.getElementById('estadoInput').value || "NUEVO LEÓN");
        const selected = document.getElementById('periodSelect').value || "all";

        document.getElementById('basePeriodLabel').textContent = basePeriod;
        document.getElementById('estadoLabel').textContent = estado;

        // KPI % inseguro (ya viene en el VM como KpiInseguridad)
        document.getElementById('kpiPct').textContent = pct(data.kpiInseguridad);
        document.getElementById('kpiPctSub').textContent =
            selected !== "all" ? `Periodo: ${selected}` : `Periodo base: ${basePeriod}`;

        // Top / Bottom muni (ya vienen)
        document.getElementById('kpiTopMuni').textContent = data.kpiMunicipioMasInseguro ?? '—';
        document.getElementById('kpiBottomMuni').textContent = data.kpiMunicipioMasSeguro ?? '—';

        // Los % del top/bottom los tomamos de las listas (si existen)
        const top = (data.municipiosMasInseguros ?? [])[0];
        const bottom = (data.municipiosMasSeguros ?? [])[0];

        document.getElementById('kpiTopMuniSub').textContent = top ? pct(top.porcentajeInseguro) : '—';
        document.getElementById('kpiBottomMuniSub').textContent = bottom ? pct(bottom.porcentajeInseguro) : '—';

        // Género gap (ya viene en el VM como KpiBrechaGenero)
        const gap = data.kpiBrechaGenero;
        document.getElementById('kpiGeneroGap').textContent =
            (gap === null || gap === undefined) ? '—' : Number(gap).toFixed(2) + ' pts';
    }

    function renderTimeChart(data) {
        const serie = data.inseguridadTiempo ?? [];
        const labels = serie.map(x => x.periodo);
        const values = serie.map(x => x.porcentajeInseguro);

        destroyIf(chartTime);
        chartTime = new Chart(document.getElementById('chartTime'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: '% Inseguro',
                    data: values,
                    tension: 0.2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: {
                    y: { min: 0, max: 100, ticks: { callback: v => v + '%' } }
                }
            }
        });
    }

    function renderHorizontalBar(canvasId, label, items) {
        const labels = (items ?? []).map(x => x.nombre);
        const values = (items ?? []).map(x => x.porcentajeInseguro);

        return new Chart(document.getElementById(canvasId), {
            type: 'bar',
            data: { labels, datasets: [{ label, data: values }] },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: { x: { min: 0, max: 100, ticks: { callback: v => v + '%' } } }
            }
        });
    }

    function renderLugarChart(data) {
        const items = (data.inseguridadPorLugar ?? []).slice(0, 12);
        const labels = items.map(x => x.lugar);
        const values = items.map(x => x.porcentajeInseguro);

        destroyIf(chartLugar);
        chartLugar = new Chart(document.getElementById('chartLugar'), {
            type: 'bar',
            data: { labels, datasets: [{ label: '% Inseguro', data: values }] },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true } },
                scales: { x: { min: 0, max: 100, ticks: { callback: v => v + '%' } } }
            }
        });
    }

        function renderGeneroChart(data) {
        let items = (data.inseguridadPorGenero ?? []).slice();

        items.reverse();

        const labels = items.map(x => x.genero);
        const values = items.map(x => x.porcentajeInseguro);

        destroyIf(chartGenero);
        chartGenero = new Chart(document.getElementById('chartGenero'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{ label: '% Inseguro', data: values }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${Number(ctx.raw).toFixed(2)}%` } }
                }
            }
        });
    }


    function renderMunicipiosCharts(data) {
        destroyIf(chartTop);
        destroyIf(chartBottom);

        chartTop = renderHorizontalBar('chartTop', '% Inseguro', data.municipiosMasInseguros ?? []);
        chartBottom = renderHorizontalBar('chartBottom', '% Inseguro', data.municipiosMasSeguros ?? []);
    }

    async function loadAndRender() {
        btnLoad.disabled = true;
        setStatus('loading', 'Cargando datos…');

        try {
            const data = await fetchData();

            updateKpis(data);
            renderTimeChart(data);
            renderMunicipiosCharts(data);
            renderLugarChart(data);
            renderGeneroChart(data);

            clearStatus();
        } catch (err) {
            console.error(err);
            setStatus('error', 'Error: ' + (err?.message ?? 'No se pudo cargar.'));
        } finally {
            btnLoad.disabled = false;
        }
    }

    btnLoad.addEventListener('click', loadAndRender);

    btnReset.addEventListener('click', () => {
        document.getElementById('estadoInput').value = 'NUEVO LEÓN';
        document.getElementById('periodSelect').value = 'all';
        loadAndRender();
    });

    // carga inicial
    loadAndRender();
</script>
